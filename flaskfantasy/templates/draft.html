{% extends "layout.html" %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="content-section">
                <legend><b>Draft</b></legend>
                <div class="card mb-2">
                    <div class="card-body bg-light pb-2">
                        <p class="card-text"><small><b>Rankings</b> are based on the <b>Fantasy Points Gap %</b> between a player and their projected positional replacement, and their <b>Priority</b>, which represents 
                                                    the likelihood a player will be available again to the current team in the following rounds based on <b>ADP</b>. Priority is determined by the following formulas:
                                                    <ul>
                                                        <li><b>High:</b> ADP &lt= Pick in the following round</li>
                                                        <li><b>Medium:</b> Pick in the following round &lt ADP &lt Pick after the following round </li>
                                                        <li><b>Low:</b> ADP &gt= Pick after the following round</li>
                                                    </ul>
                                             </small>
                        </p>
                    </div>
                </div>
             </div>   
        </div>
    </div>
    <div class="row">
        <div class="col-md-9 mb-3">
            <div class="content-section h-100">
                <h5 id="picklabel" class="border-bottom font-weight-bold p-2">{{ pick_label }}</h5>
                <div class="form-check form-check-inline">
                  <input class="search form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1" data-val="" checked>
                  <label class="form-check-label" for="inlineRadio1">All</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="search form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" data-val="QB">
                  <label class="form-check-label" for="inlineRadio2">QB</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="search form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio3" data-val="RB">
                  <label class="form-check-label" for="inlineRadio3">RB</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="search form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio4" data-val="WR">
                  <label class="form-check-label" for="inlineRadio4">WR</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="search form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio5" data-val="TE">
                  <label class="form-check-label" for="inlineRadio5">TE</label>
                </div>
                <table id="drafttable" class="table display compact">
                <div id="positionfilter" class="p-1">
                </div>
                    <thead class="">
                        <tr>
                            {% for row in headings1 %}
                            <th scope="col" class="text-center" style="white-space: nowrap">{{ row }}</th>
                            {% endfor %}
                            <th></th>
                        </tr>
                    </thead>                         
                </table>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="content-section h-100">
            <h5 id="teamlabel" class="font-weight-bold mb-3">{{ team_label }}</h5>
                <table id="teamtable" class="table display compact" style="width:100%">
                    <thead class="">
                        <tr>
                            {% for row in headings3 %}
                            <th scope="col" class="text-center">{{ row }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                </table>
            </div>            
        </div>      
    </div>
    <div class="row"> 
        <div class="col-md-9 mb-3">
           <div class="content-section h-100">
               <h5 id="nextpicklabel" class="font-weight-bold">{{ next_pick_label }}</h5>
               <h6>Projected Replacements</h6>
               <table id="repltable" class="table display compact" style="width:100%">
                   <thead class="">
                       <tr>
                           {% for row in headings2 %}
                           <th scope="col" class="text-center">{{ row }}</th>
                           {% endfor %}
                       </tr>
                   </thead>
               </table>
           </div> 
        </div> 
        <div class="col-md-3 mb-3">
            <div class="content-section h-100">
                <h5 id="prevpicklabel" class="font-weight-bold">{{ prev_pick_label }}</h5>
                <h6 id="prevteamlabel" class="border-bottom pb-2">{{ prev_team_label }}</h6>
                <div class="d-flex align-items-center flex-column justify-content-center m-auto">
                    <br><p id="prevplayerlabel">{{ prev_player_label }}</p>
                    <p id="prevposlabel">{{ prev_pos_label }}</p>
                    <div>
                        <button id="undo-btn" class="btn btn-secondary" disabled>Undo</button>
                    </div>
                </div> 
            </div>        
        </div>
    </div>
{% endblock content %}

{% block script %}
    <script>
        $(document).ready(function(){     
                       
             var drafttable = $('#drafttable').DataTable({
                  'scrollY': 365,
                  'paging': false,
                  'info': false,
                  'responsive': {
                      'details': {
                          type: 'column',
                          target: -1
                      }
                  },
                  'ajax': {
                      'url': '/draft_data',
                      'type': 'GET',
                      'dataSrc': 'draftdata'
                  },
                  'rowCallback': function ( row, data, index ) {
                        if ( data.vor_pct > 0 ) {
                        $('td:eq(5)', row).css('color', 'Green');}
                        else if ( data.vor_pct < 0 ) {
                        $('td:eq(5)', row).css('color', 'Red');} 
                  },
                  'columns': [
                      {defaultContent: '<button class="btn btn-info btn-sm pick-btn" style="padding: 2px 8px;"><b>+</b></button>'},
                      {data: 'player'},
                      {data: 'position'},
                      {data: 'fantasy_points'},
                      {data: 'vor_pts'},
                      {data: 'vor_pct'},
                      {data: 'adp'},
                      {data: {
                          _: 'priority.display',
                          sort: 'priority.priority'
                       } },
                      {defaultContent: ''}
                  ],
                   'columnDefs': [
                        { orderable: false, targets: 0 },
                        { className: 'font-weight-bold', targets: 5 },
                        { render: DataTable.render.number(',', '.', '1'), targets: [3, 4, 5, 6]},
                        { responsivePriority: 1, targets: [0, 1, 2, 5, 7]},
                        { responsivePriority: 2, targets: 4 },
                        { responsivePriority: 3, targets: 3 },
                        { responsivePriority: 4, targets: 6 },
                        { className: 'dtr-control', orderable: false, targets: -1 }
                   ],
                  'order': [[ 7, 'asc' ]]
            
            });
            
              $('.search').click(function() {
                drafttable.column(2).search($(this).data('val')).draw();
              });         
            
             var repltable = $('#repltable').DataTable({
                  'paging': false,
                  'searching': false,
                  'info': false,
                  'responsive': true,
                  'ajax': {
                      'url': '/draft_data',
                      'type': 'GET',
                      'dataSrc': 'repldata'
                  },
                  'columns': [
                      {data: 'player'},
                      {data: 'position'},
                      {data: 'fantasy_points'},
                      {data: 'adp'}
                      ],
                  'columnDefs': [
                        { render: DataTable.render.number(',', '.', '1'), targets: [2, 3] }
                      ],
                  'order': [[ 1, 'asc' ]]
            });
            
             var teamtable = $('#teamtable').DataTable({
                  'scrollY': 450,
                  'paging': false,
                  'searching': false,
                  'info': false,
                  'responsive': true,
                  'language': {'emptyTable': 'No players selected'},
                  'ajax': {
                      'url': '/draft_data',
                      'type': 'GET',
                      'dataSrc': 'teamdata'
                  },
                  'columns': [
                      {data: 'position'},
                      {data: 'player'}
                      ],
                  'columnDefs': [
                        {'width':'30%', targets: 0},
                        { responsivePriority: 1, targets: 1 }
                      ]
            });
            
        $('#drafttable tbody').on('click', '.pick-btn', function() {
            var data = drafttable.row($(this).parents('tr')).data();
            var player = data.player;
            var position = data.position;
            var fantasy_points = data.fantasy_points;
            
            req = $.ajax({
                url: '/draft_data',
                type: 'POST',
                data: {'player' : player, 'position' : position, 'fantasy_points': fantasy_points}
            });
            
            $('.pick-btn').attr("disabled", true);
            $('#undo-btn').attr("disabled", true);
            
            req.done(function(data) {
                if (data.pick_num > 1) {
                    $('#undo-btn').attr("disabled", false);                   
                    } else {
                    $('#undo-btn').attr("disabled", true);
                    };
                if (data.pick_num > data.total_picks) {
                    alert( 'That was the last pick of the draft. Good luck!' );
                    var $form=$(document.createElement('form')).css({display:'none'}).attr("method","POST").attr("action","/results");
                    $("body").append($form);
                    $form.submit();                    
                    } else {
                         drafttable.ajax.reload();
                         repltable.ajax.reload();
                         teamtable.ajax.reload();
                         $('#picklabel').text(data.pick_label);
                         $('#nextpicklabel').text(data.next_pick_label);
                         $('#teamlabel').text(data.team_label);
                         $('#prevpicklabel').text(data.prev_pick_label);
                         $('#prevteamlabel').text(data.prev_team_label);
                         $('#prevplayerlabel').text(data.prev_player_label);
                         $('#prevposlabel').text(data.prev_pos_label);
                     };
                 });

            });
            
        $('#undo-btn').on('click', function() {            
            req = $.ajax({
                url: '/draft_data',
                type: 'POST'
            });
            
            $('.pick-btn').attr("disabled", true);
            $('#undo-btn').attr("disabled", true);
            
            req.done(function(data) {
                if (data.pick_num > 1) {
                    $('#undo-btn').attr("disabled", false);                   
                    } else {
                    $('#undo-btn').attr("disabled", true);
                    };
                drafttable.ajax.reload();
                repltable.ajax.reload();
                teamtable.ajax.reload();
                $('#picklabel').text(data.pick_label);
                $('#nextpicklabel').text(data.next_pick_label);
                $('#teamlabel').text(data.team_label);
                $('#prevpicklabel').text(data.prev_pick_label);
                $('#prevteamlabel').text(data.prev_team_label);
                $('#prevplayerlabel').text(data.prev_player_label);
                $('#prevposlabel').text(data.prev_pos_label);
                 });

            });
            
        });
    </script>
{% endblock script %}